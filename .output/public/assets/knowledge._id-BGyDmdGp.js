import{c as M,j as e,e as L,u as E,r as o,X as A,q as H,s as Q}from"./main-DK-6tAy6.js";import{B as f}from"./button-CkY6mUU2.js";import{C as q,a as X,b as G,c as J,d as V,I as B}from"./input-DIUOMSeW.js";import{B as S}from"./badge-B2XLYerX.js";import{T as K,a as I,b as P,c as T}from"./tooltip-DYfrhltm.js";import{f as U,K as W}from"./KnowledgePagination-7zkuXIop.js";import{F}from"./file-text-BpDkBvi0.js";import{C as Y}from"./circle-alert-19jRNr_1.js";import{L as O}from"./loader-circle-DwSaV1tR.js";import{D as Z,a as ee,b as se,c as ae,d as te}from"./dialog-BhgrcoQE.js";import{L as z}from"./label-DLI6lelt.js";import{P as le}from"./progress-C97f4Luc.js";import{U as re}from"./upload-B9MJuww7.js";import{P as ie}from"./ProtectedRoute-CdMrE4ef.js";import{A as ne}from"./arrow-left-DqSc4F88.js";import{b as ce}from"./index-VHM_YL0a.js";import"./index-PYy017pk.js";import"./react-icons.esm-OtnF4_QE.js";import"./index-CGGIeoMh.js";import"./index-duIY_fkC.js";const oe=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],de=M("plus",oe),R={0:{label:"待处理",color:"bg-gray-500"},1:{label:"处理中",color:"bg-blue-500"},2:{label:"已完成",color:"bg-green-500"},3:{label:"失败",color:"bg-red-500"}},xe={1:"智能切片",2:"自定义切片"},me=s=>{const n=s.lastIndexOf(".");return n===-1||n===0?s:s.substring(0,n)};function he({document:s,onClick:n}){const d=R[s.embedding_stat]||R[0],h=s.embedding_stat===3&&s.failInfo,i=me(s.name||"未命名文档"),t=s.embedding_stat===2||s.embedding_stat===3;return e.jsx(K,{children:e.jsxs(q,{className:L("group hover:border-primary/50 transition-all hover:shadow-lg cursor-pointer h-full flex flex-col",h&&"border-red-200 bg-red-50/30"),onClick:n,children:[e.jsx(X,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"shrink-0",children:e.jsx(F,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(I,{children:[e.jsx(P,{asChild:!0,children:e.jsx(G,{className:"text-base font-semibold mb-1 line-clamp-2 break-all",children:i})}),e.jsx(T,{side:"top",className:"max-w-md",children:e.jsx("p",{className:"break-all",children:i})})]}),e.jsxs(I,{children:[e.jsx(P,{asChild:!0,children:e.jsx(J,{className:"text-xs line-clamp-1 break-all",children:s.url||"无URL"})}),e.jsx(T,{side:"bottom",className:"max-w-md",children:e.jsx("p",{className:"break-all text-xs",children:s.url||"无URL"})})]})]})]}),t&&e.jsx(S,{className:L("shrink-0",d.color,"text-white"),children:d.label})]})}),e.jsxs(V,{className:"pt-0 flex-1 flex flex-col",children:[h&&s.failInfo&&e.jsxs("div",{className:"mb-3 p-2 bg-red-100 border border-red-200 rounded-lg flex items-start gap-2",children:[e.jsx(Y,{className:"h-4 w-4 text-red-600 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-xs font-medium text-red-900 break-all",children:["向量化失败 (代码: ",s.failInfo.embedding_code,")"]}),e.jsx("p",{className:"text-xs text-red-700 mt-1 break-all",children:s.failInfo.embedding_msg})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"字数"}),e.jsx("div",{className:"font-semibold text-sm",children:U(s.word_num)})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"长度"}),e.jsx("div",{className:"font-semibold text-sm",children:U(s.length)})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"切片字数"}),e.jsx("div",{className:"font-semibold text-sm",children:s.sentence_size})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs(I,{children:[e.jsx(P,{asChild:!0,children:e.jsxs(S,{variant:"outline",className:"text-xs truncate max-w-[120px]",children:["ID: ",s.id.slice(0,8),"..."]})}),e.jsx(T,{children:e.jsxs("p",{className:"text-xs",children:["完整ID: ",s.id]})})]}),e.jsx(S,{variant:"secondary",className:"text-xs shrink-0",children:xe[s.knowledge_type]||"未知类型"})]})]})]})})}function pe({loading:s,refreshing:n=!1,documents:d,searchQuery:h,onDocumentClick:i}){return s&&!n?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(O,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"加载中..."})]}):d.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx(F,{className:"h-16 w-16 text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"暂无文档"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:h?"未找到匹配的文档":"该知识库还没有文档"})]}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:d.map(t=>e.jsx(he,{document:t,onClick:()=>i?.(t)},t.id))})}function fe({open:s,onOpenChange:n,knowledgeId:d,onUploadSuccess:h}){const{toast:i}=E(),[t,g]=o.useState([]),[c,v]=o.useState(!1),[m,u]=o.useState(0),p=a=>{if(a.target.files){const l=Array.from(a.target.files);g(l)}},y=a=>{g(t.filter((l,N)=>N!==a))},C=async()=>{if(t.length===0){i({title:"请选择文件",description:"请至少选择一个文件上传",variant:"destructive"});return}try{v(!0),u(0);const a=new FormData;t.forEach(x=>{a.append("files",x)});const l=setInterval(()=>{u(x=>x>=90?(clearInterval(l),90):x+10)},200),N=await fetch(`/api/knowledge/upload?id=${d}`,{method:"POST",body:a});clearInterval(l),u(100);const r=await N.json();if(N.ok&&r.code===200){const x=r.data?.successInfos?.length||0,k=r.data?.failedInfos?.length||0;i({title:"上传完成",description:`成功上传 ${x} 个文件${k>0?`, ${k} 个文件失败`:""}`}),k>0&&r.data.failedInfos.forEach(b=>{console.error(`文件 ${b.fileName} 上传失败: ${b.failReason}`)}),x>0?(i({title:"正在解析文档",description:"文档上传成功，正在后台解析中，请稍等..."}),setTimeout(()=>{h()},3e3),setTimeout(()=>{j()},5e3)):j()}else i({title:"上传失败",description:r.message||"上传文档失败",variant:"destructive"})}catch(a){console.error("上传文档错误:",a),i({title:"上传错误",description:"网络错误，请稍后重试",variant:"destructive"})}finally{v(!1)}},j=()=>{c||(g([]),u(0),n(!1))},_=t.reduce((a,l)=>a+l.size,0),w=a=>a<1024?`${a} B`:a<1024*1024?`${(a/1024).toFixed(1)} KB`:`${(a/(1024*1024)).toFixed(1)} MB`;return e.jsx(K,{children:e.jsx(Z,{open:s,onOpenChange:j,children:e.jsxs(ee,{className:"sm:max-w-[700px] max-h-[90vh] flex flex-col",children:[e.jsxs(se,{children:[e.jsx(ae,{children:"上传文档"}),e.jsx(te,{children:"支持 txt, doc, pdf, docx, ppt, pptx, md, xls, xlsx, csv 等格式"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"选择文件"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(B,{type:"file",multiple:!0,onChange:p,disabled:c,accept:".txt,.doc,.pdf,.docx,.ppt,.pptx,.md,.xls,.xlsx,.csv"})})]}),t.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(z,{children:["已选文件 (",t.length,")"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["总大小: ",w(_)]})]}),e.jsx("div",{className:"border rounded-lg divide-y max-h-[350px] overflow-y-auto",children:t.map((a,l)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 hover:bg-accent/50 transition-colors group",children:[e.jsx(F,{className:"h-5 w-5 flex-shrink-0 text-primary"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(I,{children:[e.jsx(P,{asChild:!0,children:e.jsx("p",{className:"text-sm font-medium truncate cursor-default",children:a.name})}),e.jsx(T,{side:"top",className:"max-w-md",children:e.jsx("p",{className:"break-all",children:a.name})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:w(a.size)})]}),e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>y(l),disabled:c,className:"flex-shrink-0 h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(A,{className:"h-4 w-4"})})]},l))})]}),c&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{children:"上传进度"}),e.jsxs("span",{className:"font-semibold",children:[m,"%"]})]}),e.jsx(le,{value:m})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(f,{variant:"outline",onClick:j,disabled:c,children:"取消"}),e.jsx(f,{onClick:C,disabled:c||t.length===0,children:c?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"上传中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"开始上传 (",t.length,")"]})})]})]})})})}function Re(){return e.jsx(ie,{children:e.jsx(ge,{})})}function ge(){const{id:s}=H({from:"/knowledge/$id"}),n=Q(),{toast:d}=E(),[h,i]=o.useState([]),[t,g]=o.useState(!0),[c,v]=o.useState(!1),[m,u]=o.useState(""),[p,y]=o.useState(1),[C,j]=o.useState(0),[_,w]=o.useState(!1),a=async(r=1,x="",k=!1)=>{try{k?v(!0):g(!0);const b=new URLSearchParams({knowledge_id:s,page:r.toString(),size:"20"});x&&b.append("word",x);const $=await fetch(`/api/knowledge/documents?${b.toString()}`),D=await $.json();$.ok&&D.code===200?(i(D.data.list||[]),j(D.data.total||0)):d({title:"获取失败",description:D.message||"获取文档列表失败",variant:"destructive"})}catch{d({title:"请求错误",description:"网络错误，请稍后重试",variant:"destructive"})}finally{g(!1),v(!1)}};o.useEffect(()=>{a(p,m)},[p]);const l=()=>{y(1),a(1,m,!1)},N=()=>{a(p,m,!0)};return e.jsxs("div",{className:"flex h-screen bg-background",children:[e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"border-b border-border/40 bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"flex items-center gap-3 mb-4",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>n({to:"/knowledge"}),className:"gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),"返回知识库列表"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx(B,{value:m,onChange:r=>u(r.target.value),onKeyDown:r=>r.key==="Enter"&&l(),placeholder:"搜索文档名称...",className:"max-w-md"}),e.jsx(f,{onClick:l,children:"搜索"})]}),e.jsxs(S,{variant:"secondary",className:"h-10 px-4",children:["共 ",C," 个文档"]}),e.jsxs(f,{variant:"outline",className:"gap-2",onClick:N,disabled:c,children:[e.jsx(ce,{className:`h-4 w-4 ${c?"animate-spin":""}`}),"刷新"]}),e.jsxs(f,{className:"gap-2",onClick:()=>w(!0),children:[e.jsx(de,{className:"h-4 w-4"}),"上传文档"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx(pe,{loading:t,refreshing:c,documents:h,searchQuery:m,onDocumentClick:r=>console.log("点击文档:",r)})}),!t&&e.jsx(W,{currentPage:p,total:C,pageSize:20,onPageChange:y})]}),e.jsx(fe,{open:_,onOpenChange:w,knowledgeId:s,onUploadSuccess:()=>a(p,m,!0)})]})}export{Re as component};
