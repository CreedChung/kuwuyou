import{c as O,j as e,e as F,u as z,r as o,X as R,q as M,s as A}from"./main-ARwKK-j-.js";import{B as j}from"./button-Bs-EW9hM.js";import{C as H,a as Q,b as q,c as X,d as G,I as E}from"./input-bDnrxQmw.js";import{B as k}from"./badge--bUeVP-W.js";import{T as B,a as y,b as C,c as D}from"./tooltip--B9sJpLj.js";import{f as L,K as J}from"./KnowledgePagination-B9J4yy7a.js";import{F as T}from"./file-text-CUGBTUv4.js";import{C as V}from"./circle-alert-goolNAfq.js";import{L as K}from"./loader-circle-DRCGxcyM.js";import{D as W,a as Y,b as Z,c as ee,d as se}from"./dialog-CQ2bWMgF.js";import{L as $}from"./label-gAYxsn89.js";import{P as ae}from"./progress-C9zJ7_qx.js";import{U as te}from"./upload-B40XXsd1.js";import{P as le}from"./ProtectedRoute-BxFyMMUm.js";import{A as re}from"./arrow-left-Be3PFbWq.js";import"./index-B5iswCLf.js";import"./index-D4SoSJsi.js";import"./index-EOFN1eGW.js";import"./react-icons.esm-cKvZGT2s.js";import"./index-BwYya6qp.js";const ie=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],ne=O("plus",ie),U={0:{label:"待处理",color:"bg-gray-500"},1:{label:"处理中",color:"bg-blue-500"},2:{label:"已完成",color:"bg-green-500"},3:{label:"失败",color:"bg-red-500"}},ce={1:"智能切片",2:"自定义切片"},oe=a=>{const n=a.lastIndexOf(".");return n===-1||n===0?a:a.substring(0,n)};function de({document:a,onClick:n}){const d=U[a.embedding_stat]||U[0],x=a.embedding_stat===3&&a.failInfo,l=oe(a.name||"未命名文档"),t=a.embedding_stat===2||a.embedding_stat===3;return e.jsx(B,{children:e.jsxs(H,{className:F("group hover:border-primary/50 transition-all hover:shadow-lg cursor-pointer h-full flex flex-col",x&&"border-red-200 bg-red-50/30"),onClick:n,children:[e.jsx(Q,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"shrink-0",children:e.jsx(T,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(y,{children:[e.jsx(C,{asChild:!0,children:e.jsx(q,{className:"text-base font-semibold mb-1 line-clamp-2 break-all",children:l})}),e.jsx(D,{side:"top",className:"max-w-md",children:e.jsx("p",{className:"break-all",children:l})})]}),e.jsxs(y,{children:[e.jsx(C,{asChild:!0,children:e.jsx(X,{className:"text-xs line-clamp-1 break-all",children:a.url||"无URL"})}),e.jsx(D,{side:"bottom",className:"max-w-md",children:e.jsx("p",{className:"break-all text-xs",children:a.url||"无URL"})})]})]})]}),t&&e.jsx(k,{className:F("shrink-0",d.color,"text-white"),children:d.label})]})}),e.jsxs(G,{className:"pt-0 flex-1 flex flex-col",children:[x&&a.failInfo&&e.jsxs("div",{className:"mb-3 p-2 bg-red-100 border border-red-200 rounded-lg flex items-start gap-2",children:[e.jsx(V,{className:"h-4 w-4 text-red-600 shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-xs font-medium text-red-900 break-all",children:["向量化失败 (代码: ",a.failInfo.embedding_code,")"]}),e.jsx("p",{className:"text-xs text-red-700 mt-1 break-all",children:a.failInfo.embedding_msg})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center",children:[e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"字数"}),e.jsx("div",{className:"font-semibold text-sm",children:L(a.word_num)})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"长度"}),e.jsx("div",{className:"font-semibold text-sm",children:L(a.length)})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"切片字数"}),e.jsx("div",{className:"font-semibold text-sm",children:a.sentence_size})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-between gap-2",children:[e.jsxs(y,{children:[e.jsx(C,{asChild:!0,children:e.jsxs(k,{variant:"outline",className:"text-xs truncate max-w-[120px]",children:["ID: ",a.id.slice(0,8),"..."]})}),e.jsx(D,{children:e.jsxs("p",{className:"text-xs",children:["完整ID: ",a.id]})})]}),e.jsx(k,{variant:"secondary",className:"text-xs shrink-0",children:ce[a.knowledge_type]||"未知类型"})]})]})]})})}function xe({loading:a,documents:n,searchQuery:d,onDocumentClick:x}){return a?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx(K,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"加载中..."})]}):n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx(T,{className:"h-16 w-16 text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"暂无文档"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:d?"未找到匹配的文档":"该知识库还没有文档"})]}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:n.map(l=>e.jsx(de,{document:l,onClick:()=>x?.(l)},l.id))})}function me({open:a,onOpenChange:n,knowledgeId:d,onUploadSuccess:x}){const{toast:l}=z(),[t,g]=o.useState([]),[r,b]=o.useState(!1),[p,f]=o.useState(0),w=s=>{if(s.target.files){const i=Array.from(s.target.files);g(i)}},S=s=>{g(t.filter((i,m)=>m!==s))},I=async()=>{if(t.length===0){l({title:"请选择文件",description:"请至少选择一个文件上传",variant:"destructive"});return}try{b(!0),f(0);const s=new FormData;t.forEach(c=>{s.append("files",c)});const i=setInterval(()=>{f(c=>c>=90?(clearInterval(i),90):c+10)},200),m=await fetch(`/api/knowledge/upload?id=${d}`,{method:"POST",body:s});clearInterval(i),f(100);const h=await m.json();if(m.ok&&h.code===200){const c=h.data?.successInfos?.length||0,P=h.data?.failedInfos?.length||0;l({title:"上传完成",description:`成功上传 ${c} 个文件${P>0?`, ${P} 个文件失败`:""}`}),P>0&&h.data.failedInfos.forEach(_=>{console.error(`文件 ${_.fileName} 上传失败: ${_.failReason}`)}),x(),u()}else l({title:"上传失败",description:h.message||"上传文档失败",variant:"destructive"})}catch(s){console.error("上传文档错误:",s),l({title:"上传错误",description:"网络错误，请稍后重试",variant:"destructive"})}finally{b(!1)}},u=()=>{r||(g([]),f(0),n(!1))},N=t.reduce((s,i)=>s+i.size,0),v=s=>s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`;return e.jsx(B,{children:e.jsx(W,{open:a,onOpenChange:u,children:e.jsxs(Y,{className:"sm:max-w-[700px] max-h-[90vh] flex flex-col",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:"上传文档"}),e.jsx(se,{children:"支持 txt, doc, pdf, docx, ppt, pptx, md, xls, xlsx, csv 等格式"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"选择文件"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx(E,{type:"file",multiple:!0,onChange:w,disabled:r,accept:".txt,.doc,.pdf,.docx,.ppt,.pptx,.md,.xls,.xlsx,.csv"})})]}),t.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs($,{children:["已选文件 (",t.length,")"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["总大小: ",v(N)]})]}),e.jsx("div",{className:"border rounded-lg divide-y max-h-[350px] overflow-y-auto",children:t.map((s,i)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 hover:bg-accent/50 transition-colors group",children:[e.jsx(T,{className:"h-5 w-5 flex-shrink-0 text-primary"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs(y,{children:[e.jsx(C,{asChild:!0,children:e.jsx("p",{className:"text-sm font-medium truncate cursor-default",children:s.name})}),e.jsx(D,{side:"top",className:"max-w-md",children:e.jsx("p",{className:"break-all",children:s.name})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:v(s.size)})]}),e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>S(i),disabled:r,className:"flex-shrink-0 h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(R,{className:"h-4 w-4"})})]},i))})]}),r&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{children:"上传进度"}),e.jsxs("span",{className:"font-semibold",children:[p,"%"]})]}),e.jsx(ae,{value:p})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(j,{variant:"outline",onClick:u,disabled:r,children:"取消"}),e.jsx(j,{onClick:I,disabled:r||t.length===0,children:r?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"mr-2 h-4 w-4 animate-spin"}),"上传中..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"mr-2 h-4 w-4"}),"开始上传 (",t.length,")"]})})]})]})})})}function $e(){return e.jsx(le,{children:e.jsx(he,{})})}function he(){const{id:a}=M({from:"/knowledge/$id"}),n=A(),{toast:d}=z(),[x,l]=o.useState([]),[t,g]=o.useState(!0),[r,b]=o.useState(""),[p,f]=o.useState(1),[w,S]=o.useState(0),[I,u]=o.useState(!1),N=async(s=1,i="")=>{try{g(!0);const m=new URLSearchParams({knowledge_id:a,page:s.toString(),size:"20"});i&&m.append("word",i);const h=await fetch(`/api/knowledge/documents?${m.toString()}`),c=await h.json();h.ok&&c.code===200?(l(c.data.list||[]),S(c.data.total||0)):d({title:"获取失败",description:c.message||"获取文档列表失败",variant:"destructive"})}catch{d({title:"请求错误",description:"网络错误，请稍后重试",variant:"destructive"})}finally{g(!1)}};o.useEffect(()=>{N(p,r)},[p]);const v=()=>{f(1),N(1,r)};return e.jsxs("div",{className:"flex h-screen bg-background",children:[e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx("div",{className:"border-b border-border/40 bg-background/95 backdrop-blur",children:e.jsxs("div",{className:"p-4",children:[e.jsx("div",{className:"flex items-center gap-3 mb-4",children:e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>n({to:"/knowledge"}),className:"gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),"返回知识库列表"]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-2",children:[e.jsx(E,{value:r,onChange:s=>b(s.target.value),onKeyDown:s=>s.key==="Enter"&&v(),placeholder:"搜索文档名称...",className:"max-w-md"}),e.jsx(j,{onClick:v,children:"搜索"})]}),e.jsxs(k,{variant:"secondary",className:"h-10 px-4",children:["共 ",w," 个文档"]}),e.jsxs(j,{className:"gap-2",onClick:()=>u(!0),children:[e.jsx(ne,{className:"h-4 w-4"}),"上传文档"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx(xe,{loading:t,documents:x,searchQuery:r,onDocumentClick:s=>console.log("点击文档:",s)})}),!t&&e.jsx(J,{currentPage:p,total:w,pageSize:20,onPageChange:f})]}),e.jsx(me,{open:I,onOpenChange:u,knowledgeId:a,onUploadSuccess:()=>N(p,r)})]})}export{$e as component};
